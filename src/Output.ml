(** Decorate each file with a little bit of boilerplate, then print it *)

open Utils
open PPrint


let header name previous_files =
  let default_includes = string (Printf.sprintf
{|/* This file auto-generated by KreMLin! */
#ifndef __%s_H
#define __%s_H
#include <inttypes.h>
#include <string.h>
#include <stdio.h>
#include <stdbool.h>
|} name name) in
  let extra_includes = separate_map hardline
    (fun x -> string "#include " ^^ string x) (List.rev !Options.add_include)
  in
  let includes = separate_map hardline (fun i ->
    string "#include " ^^ dquote ^^ string i ^^ string ".h" ^^ dquote
  ) previous_files in
  default_includes ^^ hardline ^^ extra_includes ^^
  hardline ^^ includes ^^ hardline ^^ hardline,
  hardline ^^ hardline ^^ string "#endif"

let write_one name prefix program suffix =
  let f =
    if !Options.tmpdir <> "" then
      !Options.tmpdir ^ "/" ^ name
    else
      name
  in
  with_open_out f (fun oc ->
    let doc =
      prefix ^^ hardline ^^ hardline ^^
      separate_map (hardline ^^ hardline) PrintC.p_decl_or_function program ^^
      suffix
    in
    PPrint.ToChannel.pretty 0.95 100 oc doc
  )

let write_c files =
  ignore (List.fold_left (fun names file ->
    let name, program = file in
    let prefix = string (Printf.sprintf "#include \"%s.h\"" name) in
    write_one (name ^ ".c") prefix program empty;
    name :: names
  ) [] files)

let write_h files =
  ignore (List.fold_left (fun names file ->
    let name, program = file in
    let prefix, suffix = header name (List.rev names) in
    write_one (name ^ ".h") prefix program suffix;
    name :: names
  ) [] files)
